import streamlit as st
import pandas as pd
import pydeck as pdk

# ãƒšãƒ¼ã‚¸è¨­å®š
st.set_page_config(page_title="5Strands Tokyo Map", layout="wide")
st.title('ğŸ’ 5Strands æ±äº¬ãƒã‚¹ã‚¿ãƒ¼æ”»ç•¥ãƒãƒƒãƒ— (åœ°å›³å¾©æ´»ç‰ˆ)')
st.markdown("""
**åœ°å›³ã®èƒŒæ™¯ï¼ˆé“è·¯åœ°å›³ï¼‰ã‚’è¡¨ç¤º**ã—ã€åœ°åã‚’**æ—¥æœ¬èª**ã«æˆ»ã—ã¾ã—ãŸã€‚
ã“ã‚Œã§ä½ç½®é–¢ä¿‚ãŒã¯ã£ãã‚Šåˆ†ã‹ã‚Šã¾ã™ã€‚
""")

# --- 1. å…¨ãƒ‡ãƒ¼ã‚¿çµ±åˆï¼ˆãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼‰ ---
data = {
    'åœ°åŸŸ': [
        'æ¸¯åŒº', 'æ¸‹è°·åŒº', 'åƒä»£ç”°åŒº', 'ä¸­å¤®åŒº', 'ç›®é»’åŒº', 
        'æ–‡äº¬åŒº', 'ä¸–ç”°è°·åŒº', 'æ–°å®¿åŒº', 'å“å·åŒº', 'æ‰ä¸¦åŒº',
        'æ±Ÿæ±åŒº', 'è±Šå³¶åŒº', 'å°æ±åŒº', 'ä¸­é‡åŒº', 'å¤§ç”°åŒº'
    ],
    'lat': [35.6581, 35.6640, 35.6938, 35.6706, 35.6413, 35.7077, 35.6461, 35.6938, 35.6092, 35.6994, 35.6725, 35.7262, 35.7126, 35.7072, 35.5612],
    'lon': [139.7515, 139.7041, 139.7536, 139.7719, 139.6981, 139.7525, 139.6541, 139.7034, 139.7302, 139.6364, 139.8174, 139.7169, 139.7802, 139.6636, 139.7158],
    
    # --- åŸºç¤ä½“åŠ› ---
    'å¹³å‡å¹´å(ä¸‡å††)': [1781, 1165, 1176, 833, 779, 762, 660, 651, 598, 556, 529, 523, 512, 495, 494],
    'ä½å®…åœ°ä¾¡(ä¸‡å††/åª)': [760, 490, 980, 490, 360, 380, 230, 300, 320, 200, 180, 240, 340, 220, 190],
    
    # --- äººé–“ãƒ»ç¾æ„è­˜ ---
    'ç¾å®¹ã‚¯ãƒªãƒ‹ãƒƒã‚¯æ•°': [180, 150, 60, 250, 40, 30, 50, 200, 45, 35, 30, 80, 40, 35, 30],
    'ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ã‚¸ãƒ æ•°': [120, 110, 50, 70, 45, 25, 60, 90, 40, 30, 35, 50, 20, 30, 25],
    
    # --- ãƒšãƒƒãƒˆãƒ»ç”Ÿæ´» ---
    'çŠ¬ã®ç™»éŒ²é ­æ•°(åƒé ­)': [8.5, 9.2, 1.8, 4.5, 12.0, 5.5, 37.0, 9.5, 11.0, 21.0, 16.5, 8.0, 6.5, 10.5, 23.0],
    'å‹•ç‰©ç—…é™¢æ•°': [35, 30, 10, 20, 40, 25, 110, 45, 40, 70, 50, 30, 25, 35, 60],
    'è‡ªç„¶æ´¾ã‚¹ãƒ¼ãƒ‘ãƒ¼æ•°': [7, 6, 2, 4, 6, 3, 12, 5, 4, 3, 3, 4, 2, 3, 2],
    
    # --- ãƒ–ãƒ©ãƒ³ãƒ‰ãƒ»å¤§ä¼æ¥­ ---
    'ç™¾è²¨åº—æ•°': [2, 3, 2, 5, 0, 0, 1, 4, 1, 0, 0, 2, 1, 1, 1],
    'ã‚»ãƒ¬ã‚¯ãƒˆã‚·ãƒ§ãƒƒãƒ—æ•°': [15, 12, 8, 10, 3, 1, 5, 8, 2, 1, 2, 3, 1, 1, 1],
    'ã‚¹ã‚¿ãƒåº—èˆ—æ•°': [100, 90, 85, 80, 30, 20, 40, 85, 35, 25, 30, 45, 25, 20, 25]
}
df = pd.DataFrame(data)

# --- 2. ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼è¨­å®š ---
st.sidebar.header('ğŸšï¸ é‡ã¿ä»˜ã‘è¨­å®š')
w_money = st.sidebar.slider('ğŸ’° çµŒæ¸ˆåŠ› (å¹´åãƒ»åœ°ä¾¡)', 0, 10, 5)
w_human = st.sidebar.slider('ğŸ’ƒ äººé–“ãƒ»ç¾æ„è­˜ (ã‚¯ãƒªãƒ‹ãƒƒã‚¯ãƒ»ç™¾è²¨åº—)', 0, 10, 5)
w_pet = st.sidebar.slider('ğŸ¶ ãƒšãƒƒãƒˆãƒ»ç”Ÿæ´» (çŠ¬æ•°ãƒ»ã‚¹ãƒ¼ãƒ‘ãƒ¼)', 0, 10, 5)
w_brand = st.sidebar.slider('â˜• ãƒ–ãƒ©ãƒ³ãƒ‰åŠ› (ã‚¹ã‚¿ãƒãƒ»ã‚»ãƒ¬ã‚¯ãƒˆ)', 0, 10, 5)

# --- 3. è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ ---
score_human = (df['ç¾å®¹ã‚¯ãƒªãƒ‹ãƒƒã‚¯æ•°']/250 + df['ç™¾è²¨åº—æ•°']/5 + df['ã‚»ãƒ¬ã‚¯ãƒˆã‚·ãƒ§ãƒƒãƒ—æ•°']/15) / 3
score_pet = (df['çŠ¬ã®ç™»éŒ²é ­æ•°(åƒé ­)']/37.0 + df['å‹•ç‰©ç—…é™¢æ•°']/110 + df['è‡ªç„¶æ´¾ã‚¹ãƒ¼ãƒ‘ãƒ¼æ•°']/12) / 3
score_eco = (df['å¹³å‡å¹´å(ä¸‡å††)']/1781 + df['ã‚¹ã‚¿ãƒåº—èˆ—æ•°']/100) / 2

df['æœ‰æœ›åº¦ã‚¹ã‚³ã‚¢'] = (
    score_eco * w_money +
    score_human * w_human +
    score_pet * w_pet +
    score_eco * w_brand
)
df['æœ‰æœ›åº¦ã‚¹ã‚³ã‚¢'] = (df['æœ‰æœ›åº¦ã‚¹ã‚³ã‚¢'] / df['æœ‰æœ›åº¦ã‚¹ã‚³ã‚¢'].max()) * 100
df['radius'] = df['æœ‰æœ›åº¦ã‚¹ã‚³ã‚¢'] * 25

# è‰²åˆ†ã‘ãƒ­ã‚¸ãƒƒã‚¯
def calculate_color(row):
    h_val = score_human[row.name] * 100
    p_val = score_pet[row.name] * 100
    total = h_val + p_val
    if total == 0: return [128, 128, 128, 150]
    r = int((h_val / total) * 255)
    b = int((p_val / total) * 255)
    return [r, 40, b, 180]

df['color_rgb'] = df.apply(calculate_color, axis=1)
df_rank = df.sort_values('æœ‰æœ›åº¦ã‚¹ã‚³ã‚¢', ascending=False)

# --- 4. åœ°å›³è¨­å®š (æ—¥æœ¬èªãƒ»æ¨™æº–åœ°å›³) ---
# å††ãƒ¬ã‚¤ãƒ¤ãƒ¼
layer_scatter = pdk.Layer(
    "ScatterplotLayer",
    df_rank,
    get_position='[lon, lat]',
    get_color='color_rgb',
    get_radius='radius',
    pickable=True,
)

# æ–‡å­—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆæ—¥æœ¬èªï¼‰
layer_text = pdk.Layer(
    "TextLayer",
    df_rank,
    get_position='[lon, lat]',
    get_text='åœ°åŸŸ', # ã“ã“ã‚’æ—¥æœ¬èªã®åˆ—åã«æˆ»ã—ã¾ã—ãŸ
    get_color='[0, 0, 0, 255]',
    get_size=15,
    get_alignment_baseline="'bottom'",
    get_text_anchor="'middle'",
    get_background_color='[255, 255, 255, 200]',
    billboard=True
)

view_state = pdk.ViewState(
    latitude=35.68,
    longitude=139.74,
    zoom=10.5,
    pitch=0,
)

# --- 5. è¡¨ç¤ºã‚¨ãƒªã‚¢ ---
col1, col2 = st.columns([3, 1])

with col1:
    st.subheader('ğŸ“ 5Strands æ±äº¬æ”»ç•¥ãƒãƒƒãƒ—')
    st.pydeck_chart(pdk.Deck(
        # ã“ã“ã‚’å¤‰æ›´ï¼šNoneã«ã™ã‚‹ã¨ã€Streamlitæ¨™æº–ã®ã€Œç¢ºå®Ÿã«æ˜ ã‚‹åœ°å›³ã€ã«ãªã‚Šã¾ã™
        map_style=None, 
        initial_view_state=view_state,
        layers=[layer_scatter, layer_text],
        tooltip={
            "html": """
            <div style='font-size:14px; font-weight:bold;'>{åœ°åŸŸ} (ã‚¹ã‚³ã‚¢:{æœ‰æœ›åº¦ã‚¹ã‚³ã‚¢:.0f})</div>
            <hr/>
            <b>ğŸ’° çµŒæ¸ˆãƒ»ãƒ–ãƒ©ãƒ³ãƒ‰</b><br/>
            å¹´å: {å¹³å‡å¹´å(ä¸‡å††)}ä¸‡å††<br/>
            ã‚¹ã‚¿ãƒ: {ã‚¹ã‚¿ãƒåº—èˆ—æ•°}åº—<br/>
            <br/>
            <b>ğŸ’ƒ ç¾å®¹ãƒ»ãƒ©ã‚°ã‚¸ãƒ¥ã‚¢ãƒªãƒ¼</b><br/>
            ç™¾è²¨åº—: {ç™¾è²¨åº—æ•°} / ã‚»ãƒ¬ã‚¯ãƒˆ: {ã‚»ãƒ¬ã‚¯ãƒˆã‚·ãƒ§ãƒƒãƒ—æ•°}<br/>
            ã‚¯ãƒªãƒ‹ãƒƒã‚¯: {ç¾å®¹ã‚¯ãƒªãƒ‹ãƒƒã‚¯æ•°}é™¢<br/>
            <br/>
            <b>ğŸ¶ ãƒšãƒƒãƒˆãƒ»ç”Ÿæ´»</b><br/>
            çŠ¬ç™»éŒ²: {çŠ¬ã®ç™»éŒ²é ­æ•°(åƒé ­)}åƒé ­<br/>
            è‡ªç„¶æ´¾ã‚¹ãƒ¼ãƒ‘ãƒ¼: {è‡ªç„¶æ´¾ã‚¹ãƒ¼ãƒ‘ãƒ¼æ•°}åº—
            """,
            "style": {"backgroundColor": "white", "color": "black", "border": "1px solid #ccc"}
        }
    ))

with col2:
    st.subheader('ğŸ“Š ãƒ©ãƒ³ã‚­ãƒ³ã‚°No.1')
    top = df_rank.iloc[0]
    st.success(f"**{top['åœ°åŸŸ']}**")
    st.write("â–¼ ä¸»è¦ãƒ‡ãƒ¼ã‚¿")
    st.write(f"ğŸ¶ çŠ¬: {top['çŠ¬ã®ç™»éŒ²é ­æ•°(åƒé ­)']}åƒé ­")
    st.write(f"ğŸ¬ ç™¾è²¨åº—: {top['ç™¾è²¨åº—æ•°']}åº—èˆ—")
    st.write(f"â˜• ã‚¹ã‚¿ãƒ: {top['ã‚¹ã‚¿ãƒåº—èˆ—æ•°']}åº—èˆ—")

# --- 6. å…¨ãƒ‡ãƒ¼ã‚¿æ¯”è¼ƒè¡¨ ---
st.markdown("### ğŸ“‹ å…¨ãƒ‡ãƒ¼ã‚¿è©³ç´°")
display_cols = [
    'åœ°åŸŸ', 'æœ‰æœ›åº¦ã‚¹ã‚³ã‚¢', 
    'å¹³å‡å¹´å(ä¸‡å††)', 'ä½å®…åœ°ä¾¡(ä¸‡å††/åª)',
    'ç™¾è²¨åº—æ•°', 'ã‚»ãƒ¬ã‚¯ãƒˆã‚·ãƒ§ãƒƒãƒ—æ•°', 'ã‚¹ã‚¿ãƒåº—èˆ—æ•°',
    'çŠ¬ã®ç™»éŒ²é ­æ•°(åƒé ­)', 'å‹•ç‰©ç—…é™¢æ•°',
    'ç¾å®¹ã‚¯ãƒªãƒ‹ãƒƒã‚¯æ•°', 'è‡ªç„¶æ´¾ã‚¹ãƒ¼ãƒ‘ãƒ¼æ•°'
]
st.dataframe(df_rank[display_cols])