import streamlit as st
import pandas as pd
import pydeck as pdk

# ãƒšãƒ¼ã‚¸è¨­å®š
st.set_page_config(page_title="5Strands Ultimate Map", layout="wide")
st.title('ğŸ’ 5Strands æ±äº¬ãƒ»å®Œå…¨çµ±åˆã‚¢ãƒ«ãƒ†ã‚£ãƒ¡ãƒƒãƒˆãƒãƒƒãƒ—')
st.markdown("""
ã“ã‚Œã¾ã§åˆ†æã—ãŸ**ã€Œå…¨13æŒ‡æ¨™ã€**ã‚’ã™ã¹ã¦æ­è¼‰ã—ã¾ã—ãŸã€‚
å¹´åãƒ»ãƒšãƒƒãƒˆãƒ»ç¾å®¹ãƒ»ãƒ–ãƒ©ãƒ³ãƒ‰ãƒ»æ•™è‚²ãªã©ã€ã‚ã‚‰ã‚†ã‚‹è§’åº¦ã‹ã‚‰ã‚¨ãƒªã‚¢ã‚’è©•ä¾¡ã§ãã¾ã™ã€‚
""")

# --- 1. å…¨ãƒ‡ãƒ¼ã‚¿å®šç¾©ï¼ˆã“ã“ãŒå…¨ã¦ã®æºã§ã™ï¼‰ ---
data = {
    'åœ°åŸŸ': [
        'æ¸¯åŒº', 'æ¸‹è°·åŒº', 'åƒä»£ç”°åŒº', 'ä¸­å¤®åŒº', 'ç›®é»’åŒº', 
        'æ–‡äº¬åŒº', 'ä¸–ç”°è°·åŒº', 'æ–°å®¿åŒº', 'å“å·åŒº', 'æ‰ä¸¦åŒº',
        'æ±Ÿæ±åŒº', 'è±Šå³¶åŒº', 'å°æ±åŒº', 'ä¸­é‡åŒº', 'å¤§ç”°åŒº'
    ],
    'lat': [35.6581, 35.6640, 35.6938, 35.6706, 35.6413, 35.7077, 35.6461, 35.6938, 35.6092, 35.6994, 35.6725, 35.7262, 35.7126, 35.7072, 35.5612],
    'lon': [139.7515, 139.7041, 139.7536, 139.7719, 139.6981, 139.7525, 139.6541, 139.7034, 139.7302, 139.6364, 139.8174, 139.7169, 139.7802, 139.6636, 139.7158],
    
    # ğŸ’° çµŒæ¸ˆãƒ»åŸºç¤
    'å¹³å‡å¹´å(ä¸‡å††)': [1781, 1165, 1176, 833, 779, 762, 660, 651, 598, 556, 529, 523, 512, 495, 494],
    'ä½å®…åœ°ä¾¡(ä¸‡å††/åª)': [760, 490, 980, 490, 360, 380, 230, 300, 320, 200, 180, 240, 340, 220, 190],
    
    # ğŸ’ƒ äººé–“ãƒ»ç¾å®¹ãƒ»æ¶ˆè²»
    'ç¾å®¹ã‚¯ãƒªãƒ‹ãƒƒã‚¯æ•°': [180, 150, 60, 250, 40, 30, 50, 200, 45, 35, 30, 80, 40, 35, 30],
    'ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ã‚¸ãƒ æ•°': [120, 110, 50, 70, 45, 25, 60, 90, 40, 30, 35, 50, 20, 30, 25],
    'ç™¾è²¨åº—æ•°': [2, 3, 2, 5, 0, 0, 1, 4, 1, 0, 0, 2, 1, 1, 1],
    'ã‚»ãƒ¬ã‚¯ãƒˆã‚·ãƒ§ãƒƒãƒ—æ•°': [15, 12, 8, 10, 3, 1, 5, 8, 2, 1, 2, 3, 1, 1, 1],
    
    # ğŸ¶ ãƒšãƒƒãƒˆãƒ»ç”Ÿæ´»
    'çŠ¬ã®ç™»éŒ²é ­æ•°(åƒé ­)': [8.5, 9.2, 1.8, 4.5, 12.0, 5.5, 37.0, 9.5, 11.0, 21.0, 16.5, 8.0, 6.5, 10.5, 23.0],
    'å‹•ç‰©ç—…é™¢æ•°': [35, 30, 10, 20, 40, 25, 110, 45, 40, 70, 50, 30, 25, 35, 60],
    'è‡ªç„¶æ´¾ã‚¹ãƒ¼ãƒ‘ãƒ¼æ•°': [7, 6, 2, 4, 6, 3, 12, 5, 4, 3, 3, 4, 2, 3, 2],
    
    # â˜• ãƒ–ãƒ©ãƒ³ãƒ‰ãƒ»ä¼æ¥­
    'ã‚¹ã‚¿ãƒåº—èˆ—æ•°': [100, 90, 85, 80, 30, 20, 40, 85, 35, 25, 30, 45, 25, 20, 25],
    'æˆåŸçŸ³äº•åº—èˆ—æ•°': [25, 20, 22, 15, 12, 8, 18, 15, 10, 8, 10, 12, 8, 5, 8],
    
    # ğŸ“ æ•™è‚² (New!)
    'ã‚¤ãƒ³ã‚¿ãƒ¼æ ¡æ•°': [25, 18, 5, 4, 8, 3, 15, 6, 7, 4, 8, 2, 2, 3, 4]
}
df = pd.DataFrame(data)

# --- 2. ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼è¨­å®š ---
st.sidebar.header('ğŸšï¸ é‡ã¿ä»˜ã‘ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«')
st.sidebar.write("é‡è¦–ã—ãŸã„é …ç›®ã®ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’ä¸Šã’ã¦ãã ã•ã„")

w_eco = st.sidebar.slider('ğŸ’° çµŒæ¸ˆ (å¹´åãƒ»åœ°ä¾¡)', 0, 10, 5)
w_beauty = st.sidebar.slider('ğŸ’ƒ ç¾å®¹ãƒ»è²·ç‰© (ã‚¯ãƒªãƒ‹ãƒƒã‚¯ãƒ»ç™¾è²¨åº—)', 0, 10, 5)
w_pet = st.sidebar.slider('ğŸ¶ ãƒšãƒƒãƒˆãƒ»ç”Ÿæ´» (çŠ¬ãƒ»ã‚¹ãƒ¼ãƒ‘ãƒ¼)', 0, 10, 5)
w_brand = st.sidebar.slider('â˜• ãƒ–ãƒ©ãƒ³ãƒ‰ (ã‚¹ã‚¿ãƒãƒ»æˆåŸçŸ³äº•)', 0, 10, 5)
w_edu = st.sidebar.slider('ğŸ“ æ•™è‚² (ã‚¤ãƒ³ã‚¿ãƒ¼ãƒŠã‚·ãƒ§ãƒŠãƒ«ã‚¹ã‚¯ãƒ¼ãƒ«)', 0, 10, 5)

# --- 3. è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ ---
# å„åˆ†é‡ã”ã¨ã®ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—ï¼ˆæ­£è¦åŒ–ï¼‰
# çµŒæ¸ˆã‚¹ã‚³ã‚¢
s_eco = (df['å¹³å‡å¹´å(ä¸‡å††)']/1781 + df['ä½å®…åœ°ä¾¡(ä¸‡å††/åª)']/980) / 2
# ç¾å®¹ãƒ»è²·ç‰©ã‚¹ã‚³ã‚¢
s_beauty = (df['ç¾å®¹ã‚¯ãƒªãƒ‹ãƒƒã‚¯æ•°']/250 + df['ç™¾è²¨åº—æ•°']/5 + df['ã‚»ãƒ¬ã‚¯ãƒˆã‚·ãƒ§ãƒƒãƒ—æ•°']/15 + df['ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ã‚¸ãƒ æ•°']/120) / 4
# ãƒšãƒƒãƒˆãƒ»ç”Ÿæ´»ã‚¹ã‚³ã‚¢
s_pet = (df['çŠ¬ã®ç™»éŒ²é ­æ•°(åƒé ­)']/37.0 + df['å‹•ç‰©ç—…é™¢æ•°']/110 + df['è‡ªç„¶æ´¾ã‚¹ãƒ¼ãƒ‘ãƒ¼æ•°']/12) / 3
# ãƒ–ãƒ©ãƒ³ãƒ‰ã‚¹ã‚³ã‚¢
s_brand = (df['ã‚¹ã‚¿ãƒåº—èˆ—æ•°']/100 + df['æˆåŸçŸ³äº•åº—èˆ—æ•°']/25) / 2
# æ•™è‚²ã‚¹ã‚³ã‚¢
s_edu = df['ã‚¤ãƒ³ã‚¿ãƒ¼æ ¡æ•°'] / 25

# ç·åˆã‚¹ã‚³ã‚¢è¨ˆç®—
df['æœ‰æœ›åº¦ã‚¹ã‚³ã‚¢'] = (
    s_eco * w_eco +
    s_beauty * w_beauty +
    s_pet * w_pet +
    s_brand * w_brand +
    s_edu * w_edu
)
df['æœ‰æœ›åº¦ã‚¹ã‚³ã‚¢'] = (df['æœ‰æœ›åº¦ã‚¹ã‚³ã‚¢'] / df['æœ‰æœ›åº¦ã‚¹ã‚³ã‚¢'].max()) * 100
df['radius'] = df['æœ‰æœ›åº¦ã‚¹ã‚³ã‚¢'] * 25

# è‰²åˆ†ã‘ãƒ­ã‚¸ãƒƒã‚¯
# èµ¤ç³» = äººé–“ãƒ»ç¾å®¹ãƒ»æ•™è‚²ï¼ˆéƒ½ä¼šçš„ï¼‰
# é’ç³» = ãƒšãƒƒãƒˆãƒ»ç”Ÿæ´»ï¼ˆå±…ä½çš„ï¼‰
def calculate_color(row):
    # éƒ½ä¼šè¦ç´ 
    city_val = (s_beauty[row.name] + s_edu[row.name] + s_brand[row.name]) * 100
    # ç”Ÿæ´»è¦ç´ 
    life_val = (s_pet[row.name]) * 100 * 2 # ãƒšãƒƒãƒˆè¦ç´ ã‚’å°‘ã—å¼·èª¿
    
    total = city_val + life_val
    if total == 0: return [128, 128, 128, 150]
    
    r = int((city_val / total) * 255)
    b = int((life_val / total) * 255)
    
    return [r, 20, b, 180]

df['color_rgb'] = df.apply(calculate_color, axis=1)
df_rank = df.sort_values('æœ‰æœ›åº¦ã‚¹ã‚³ã‚¢', ascending=False)

# --- 4. åœ°å›³è¨­å®š ---
layer_scatter = pdk.Layer(
    "ScatterplotLayer",
    df_rank,
    get_position='[lon, lat]',
    get_color='color_rgb',
    get_radius='radius',
    pickable=True,
)

layer_text = pdk.Layer(
    "TextLayer",
    df_rank,
    get_position='[lon, lat]',
    get_text='åœ°åŸŸ',
    get_color='[0, 0, 0, 255]',
    get_size=15,
    get_alignment_baseline="'bottom'",
    get_text_anchor="'middle'",
    get_background_color='[255, 255, 255, 200]',
    billboard=True
)

view_state = pdk.ViewState(
    latitude=35.68,
    longitude=139.74,
    zoom=10.5,
    pitch=0,
)

# --- 5. è¡¨ç¤ºã‚¨ãƒªã‚¢ ---
col1, col2 = st.columns([3, 1])

with col1:
    st.subheader('ğŸ“ å…¨ãƒ‡ãƒ¼ã‚¿æ­è¼‰ã‚¢ãƒ«ãƒ†ã‚£ãƒ¡ãƒƒãƒˆãƒãƒƒãƒ—')
    st.pydeck_chart(pdk.Deck(
        map_style=None, # æ¨™æº–åœ°å›³ï¼ˆæ—¥æœ¬èªãƒ»é“è·¯ã‚ã‚Šï¼‰
        initial_view_state=view_state,
        layers=[layer_scatter, layer_text],
        tooltip={
            "html": """
            <div style='font-size:14px; font-weight:bold;'>{åœ°åŸŸ} (ã‚¹ã‚³ã‚¢:{æœ‰æœ›åº¦ã‚¹ã‚³ã‚¢:.0f})</div>
            <hr/>
            <b>ğŸ’° çµŒæ¸ˆãƒ»ãƒ–ãƒ©ãƒ³ãƒ‰</b><br/>
            å¹´å: {å¹³å‡å¹´å(ä¸‡å††)}ä¸‡å††<br/>
            ã‚¹ã‚¿ãƒ: {ã‚¹ã‚¿ãƒåº—èˆ—æ•°} / æˆåŸçŸ³äº•: {æˆåŸçŸ³äº•åº—èˆ—æ•°}<br/>
            <br/>
            <b>ğŸ“ æ•™è‚²ãƒ»ç¾å®¹</b><br/>
            ã‚¤ãƒ³ã‚¿ãƒ¼æ ¡: {ã‚¤ãƒ³ã‚¿ãƒ¼æ ¡æ•°}æ ¡<br/>
            ã‚¯ãƒªãƒ‹ãƒƒã‚¯: {ç¾å®¹ã‚¯ãƒªãƒ‹ãƒƒã‚¯æ•°} / ç™¾è²¨åº—: {ç™¾è²¨åº—æ•°}<br/>
            <br/>
            <b>ğŸ¶ ãƒšãƒƒãƒˆãƒ»ç”Ÿæ´»</b><br/>
            çŠ¬ç™»éŒ²: {çŠ¬ã®ç™»éŒ²é ­æ•°(åƒé ­)}åƒé ­<br/>
            å‹•ç‰©ç—…é™¢: {å‹•ç‰©ç—…é™¢æ•°}è»’
            """,
            "style": {"backgroundColor": "white", "color": "black", "border": "1px solid #ccc"}
        }
    ))

with col2:
    st.subheader('ğŸ“Š ç·åˆãƒ©ãƒ³ã‚­ãƒ³ã‚°')
    top = df_rank.iloc[0]
    st.success(f"No.1: **{top['åœ°åŸŸ']}**")
    st.write("â–¼ ã‚¨ãƒªã‚¢ã®ç‰¹å¾´")
    st.write(f"ğŸ“ ã‚¤ãƒ³ã‚¿ãƒ¼æ ¡: {top['ã‚¤ãƒ³ã‚¿ãƒ¼æ ¡æ•°']}æ ¡")
    st.write(f"ğŸ¶ çŠ¬ç™»éŒ²æ•°: {top['çŠ¬ã®ç™»éŒ²é ­æ•°(åƒé ­)']}åƒé ­")
    st.write(f"â˜• ã‚¹ã‚¿ãƒ: {top['ã‚¹ã‚¿ãƒåº—èˆ—æ•°']}åº—èˆ—")

# --- 6. å…¨ãƒ‡ãƒ¼ã‚¿æ¯”è¼ƒè¡¨ï¼ˆå…¨é …ç›®è¡¨ç¤ºï¼‰ ---
st.markdown("### ğŸ“‹ å…¨13æŒ‡æ¨™ãƒ»è©³ç´°ãƒ‡ãƒ¼ã‚¿ä¸€è¦§")
st.markdown("ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒä¸€ã¤ã®è¡¨ã§æ¯”è¼ƒã§ãã¾ã™ã€‚åˆ—ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ä¸¦ã³æ›¿ãˆã§ãã¾ã™ã€‚")

# è¡¨ç¤ºé †åºã‚’æ•´ç†
display_cols = [
    'åœ°åŸŸ', 'æœ‰æœ›åº¦ã‚¹ã‚³ã‚¢', 
    'å¹³å‡å¹´å(ä¸‡å††)', 'ä½å®…åœ°ä¾¡(ä¸‡å††/åª)', # çµŒæ¸ˆ
    'ã‚¤ãƒ³ã‚¿ãƒ¼æ ¡æ•°', 'ç¾å®¹ã‚¯ãƒªãƒ‹ãƒƒã‚¯æ•°', 'ç™¾è²¨åº—æ•°', 'ã‚»ãƒ¬ã‚¯ãƒˆã‚·ãƒ§ãƒƒãƒ—æ•°', # äººé–“ãƒ»æ•™è‚²
    'çŠ¬ã®ç™»éŒ²é ­æ•°(åƒé ­)', 'å‹•ç‰©ç—…é™¢æ•°', 'è‡ªç„¶æ´¾ã‚¹ãƒ¼ãƒ‘ãƒ¼æ•°', # ãƒšãƒƒãƒˆãƒ»ç”Ÿæ´»
    'ã‚¹ã‚¿ãƒåº—èˆ—æ•°', 'æˆåŸçŸ³äº•åº—èˆ—æ•°' # ãƒ–ãƒ©ãƒ³ãƒ‰
]

st.dataframe(df_rank[display_cols])